# ADR-001: RFC 7807 Problem Details для ошибок API

- Status: accepted
- Date: 2025-11-17
- Tags: errors, rfc7807, security, observability

## Context

API Task Tracker должен предоставлять клиенту безопасный и предсказуемый формат ошибок.
Сейчас:
- ошибки разных типов формируются по-разному;
- детали исключений (внутренние сообщения Python/ORM) могут попасть в ответ пользователю;
- нет возможности трассировать ошибку с логами.

Это создаёт риск утечки технических деталей и осложняет сопровождение.

Связь с предыдущими практиками:
- **NFR-SEC-05** — Логирование ошибок с ключевыми метаданными (user_id/timestamp/correlation) 
- Требования P04: обработка ошибок при работе с задачами (валидация)
- Риск: `RISK-API-DetailsLeak` — раскрытие внутренних сообщений в API-ответах

## Decision

Принять единый стандарт ошибок **RFC 7807 Problem Details**:

Обязательные поля ответа:
| Поле | Назначение |
|------|------------|
| `type` | Семантика ошибки (URI вида `/problems/...`) |
| `title` | Человеко-читабельный тип |
| `status` | HTTP-код |
| `detail` | Сообщение без внутренних деталей |
| `instance` | URL запроса |
| `correlation_id` | UUID для связи с логами |

Для ошибок валидации:
| Дополнение | Значение |
|-----------|----------|
| `errors` | список ошибок FastAPI/Pydantic |

Техническая реализация:
- middleware добавляет `correlation_id` для каждого запроса
- хэндлеры:
  - `RequestValidationError → 400 Validation error`
  - `HTTPException → статус из исключения`
  - `Exception → 500 без стека в ответе`
- любые подробности логируются только на сервере

## Consequences

**Плюсы**
- Нет утечки внутренних сообщений API
- Улучшенная трассировка, связка ошибок ↔ логи (`correlation_id`)
- Единый формат ошибок уменьшает код клиентов

**Минусы**
- Требуется адаптация тестов и проверку CI
- Клиенты старого формата ошибок должны быть обновлены

## Links

- Связанные NFR: `NFR-SEC-05` (логирование ошибок)
- Риск: `RISK-API-DetailsLeak`
- Проверка:  
  - `tests/test_errors_rfc7807.py`  
  - CI: pytest + linters

## Risk Closure Criteria

Риск считается закрытым, если:
1. Все 4xx/5xx возвращаются в RFC 7807 JSON.
2. Стек трейсы и внутренние ошибки не видны в ответе.
3. Каждое исключение логируется с `correlation_id`.
4. Все тесты проходят успешно в CI.
