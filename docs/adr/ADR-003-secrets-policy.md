# ADR-003: Политика работы с секретами и конфиденциальными данными

- Status: accepted
- Date: 2025-11-17
- Tags: secrets, jwt, passwords, env-config, security

## Context

В Task Tracker используются конфиденциальные данные:
- хеши паролей пользователей,
- JWT-секрет,
- строка подключения к БД,
- ключи шифрования и служебные токены (опционально).

Неправильное обращение с секретами может привести к:
- утечке токенов и паролей,
- компрометации аккаунтов,
- взлому базы данных,
- проблемам соответствия требованиям безопасности.

Связь с предыдущими практиками (P03/P04):

- **NFR-SEC-01 — Защита паролей**: Argon2id (time_cost ≥ 3, memory_cost ≥ 64MB)  
- **NFR-SEC-02 — JWT TTL ≤ 3600s**  
- **NFR-SEC-06 — Ротация секретов каждые ≤ 90 дней**  
  

Также логическая связь:
- `AUTH-01` из `NFR_TRACEABILITY.md`: регистрация/логин должен использовать безопасные секреты 

## Decision

Принять следующие правила обработки секретов:

### 1️⃣ Источник секретов
Секреты загружаются только из:
- переменных окружения
- файла `.env` (который не коммитится)
- секретов CI/CD (GitHub Secrets)

### 2️⃣ Запрет секретов в репозитории
- В коде недопустимы:
  - реальные ключи JWT
  - пароли БД и сервисов
  - токены интеграций
- В `.env.example` — только фиктивные значения

### 3️⃣ Защита паролей пользователей (Argon2id)
- Параметры хеширования соответствуют требованиям:
  - `time_cost >= 3`
  - `memory_cost >= 64 MB`  
  (соответствует NFR-SEC-01)

### 4️⃣ Безопасность JWT токена
- Извлекается исключительно из среды
- TTL ≤ 60 минут (NFR-SEC-02)
- Логирование **не** включает содержимое токенов

### 5️⃣ Ротация секретов
- JWT-секрет и другие секреты обновляются ≤ 90 дней
  (NFR-SEC-06)
- Новые значения применяются без изменения кода

### 6️⃣ Проверки и автоматизация
- Проверки на утечки должны быть частью CI:
  - **gitleaks**
  - **semgrep**
- Любая находка блокирует merge

## Consequences

### Positive
- Значительно уменьшается риск компрометации пользователей
- Не требуется менять код при ротации секретов
- Репозиторий остаётся безопасным для публикации
- Соответствие NFR по безопасности

### Negative
- Локальная настройка окружения сложнее для новичков
- Требуется инфраструктура для безопасного хранения секретов

## Links

- NFR: `NFR-SEC-01`, `NFR-SEC-02`, `NFR-SEC-06`  (P03)
- User Stories: `AUTH-01`  (регистрация/логин) 
- Контроль:
  - `.env.example`
  - проверки в CI: gitleaks, semgrep
  - тесты хеширования и TTL токенов

## Risk Closure Criteria

Риски считаются закрытыми, если:
1. В репозитории отсутствуют реальные секреты (проверяется CI).
2. Все секреты загружаются только из переменных среды / локального `.env`.
3. Пароли хранятся с Argon2id и требуемыми параметрами.
4. JWT имеет TTL ≤ 3600 сек.
5. Ротация секретов не требует изменения кода.
