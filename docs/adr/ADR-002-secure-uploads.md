# ADR-002: Безопасная загрузка файлов (secure uploads)

- Status: accepted
- Date: 2025-11-17
- Tags: uploads, validation, security, rfc7807

## Context

В сервисе Task Tracker появляется функциональность загрузки файлов (вложения к задачам, скриншоты и т.п.).
Связанные риски:

- загрузка слишком больших файлов → риск DoS по диску/памяти/CPU;
- несоответствие заявленного `Content-Type` и реального содержимого (поддельные PNG/JPEG/PDF);
- попытки path traversal (`../../etc/passwd`) через имя файла;
- использование небезопасных путей и симлинков.

Связь с предыдущими практиками (P03/P04):

- **NFR-SEC-05 — Логирование ошибок**: все 4xx/5xx должны логироваться с ключевыми метаданными (user_id, timestamp и т.п.), ошибки загрузки не исключение.
- **NFR-SEC-07 — Время ответа API**: p95 ≤ 300ms при нагрузке, значит нужно ограничивать размер/формат файлов, чтобы не допустить деградации.
- Story/API-05 (ограничение частоты запросов) логически связан с защитой от злоупотреблений upload-эндпоинтом.

Дополнительно этот ADR закрывает риски типа:
- `RISK-UPLOAD-DOS` — попытка перегрузить сервис большими файлами.
- `RISK-UPLOAD-PATH-TRAVERSAL` — запись файлов вне допустимого каталога.

## Decision

Вводим отдельный, безопасный эндпоинт для загрузки файлов:

- `POST /api/v1/uploads` — загрузка одного файла.

Ключевые решения:

1. **Ограничение размера файла**

   - Задаём `MAX_UPLOAD_SIZE` (например, 5 МБ).
   - При превышении лимита возвращаем **413 Payload Too Large** в формате RFC 7807.
   - Размер проверяется до записи файла на диск.

2. **Проверка magic bytes (сигнатуры файла)**

   - Поддерживаем небольшой whitelist форматов:
     - PNG (`\x89PNG\r\n\x1a\n`)
     - JPEG (`\xff\xd8\xff`)
     - PDF (`%PDF-`)
   - Определяем тип по первым байтам, а не только по MIME-заголовку.
   - Если фактический тип не совпадает с ожидаемым / не поддерживается — возвращаем **400 Bad Request** (RFC 7807).

3. **Безопасные имена и пути**

   - Игнорируем исходное имя файла, передаваемое клиентом.
   - Имя файла генерируется на стороне сервера: `UUID + разрешённое расширение`.
   - Каталог загрузок фиксирован: `uploads/` в файловой системе сервиса.
   - Используем только канонизованный путь (`resolve`) и проверяем, что файл попадает внутрь `uploads/` (никаких `../`).
   - Симлинки и произвольные пути для upload не используются.

4. **Формат ошибок — RFC 7807**

   - Все ошибки upload-эндпоинта возвращаются в формате RFC 7807 с полями:
     - `type`, `title`, `status`, `detail`, `instance`, `correlation_id`.
   - Поведение согласовано с ADR-001 (Problem Details).
   - Любые технические детали пишутся только в логи.

5. **Логирование**

   - Все ошибки загрузки логируются с:
     - `correlation_id`,
     - информацией о пользователе (если доступна),
     - типом и размером файла.
   - Это поддерживает выполнение **NFR-SEC-05**.

## Consequences

### Positive

- Снижается риск DoS за счёт ограничения размера и типов файлов.
- Path traversal невозможен: имя файла не контролируется клиентом.
- Единый формат ошибок (RFC 7807) упрощает обработку на клиенте.
- Логирование ошибок загрузки подпадает под существующие NFR по наблюдаемости.

### Negative

- Поддерживается ограниченный набор типов файлов (PNG/JPEG/PDF).
- Потребуется дополнительное место на диске и политика очистки (вне рамок этого ADR).
- Нужно добавить и поддерживать тесты для негативных сценариев.

## Links

- Связанные NFR (P03):
  - `NFR-SEC-05` — Логирование ошибок
  - `NFR-SEC-07` — Время ответа API (защита от тяжёлых upload-запросов)
- Связанные требования/функции (P04):
  - `F-UPLOAD-01` — Загрузка вложений к задачам
  - `R-UPLOAD-SEC` — Проверка типа и размера файлов при загрузке
- Связанные риски:
  - `RISK-UPLOAD-DOS`
  - `RISK-UPLOAD-PATH-TRAVERSAL`
- Тесты:
  - `tests/test_uploads_secure.py::test_upload_valid_png_ok`
  - `tests/test_uploads_secure.py::test_upload_too_big_returns_413`
  - `tests/test_uploads_secure.py::test_upload_invalid_magic_returns_rfc7807`
  - `tests/test_uploads_secure.py::test_upload_traversal_filename_ignored`

## Risk closure criteria

Риски, связанные с загрузками файлов, считаются закрытыми, если:

1. Файлы размером выше `MAX_UPLOAD_SIZE` стабильно приводят к ответу **413** в формате RFC 7807.
2. Файлы с неподходящей сигнатурой (поддельные PNG/JPEG/PDF) приводят к ответу **400** в формате RFC 7807.
3. Имя файла вида `../../etc/passwd` или аналогичные не могут привести к записи файла вне каталога `uploads/`.
4. Все тесты из секции *Links* проходят в CI.
